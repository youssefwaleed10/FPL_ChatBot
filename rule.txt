// Final, definitive query for rule.txt: Unifying all players by Surname for maximum resilience.

// 1. Match all player fragments and related data
MATCH (p:Player)-[:PLAYS_AS]->(pos:Position)
MATCH (p)-[played:PLAYED_IN]->(f:Fixture)
MATCH (f)-[:HAS_GW]->(gw:Gameweek)

// 2. Group all data by the player's Surname (the most stable analytical key)
WITH head(split(p.name, ' ')) AS player_surname, 
     collect(DISTINCT p.name) AS all_names, // Collect all name fragments for the final output
     collect(DISTINCT TRIM(pos.name)) AS all_positions, // Collect all unique positions
     collect({
        played: played, 
        fixture: f, 
        gameweek: gw
    }) AS all_match_data

// 3. Filter for Conflict: Must have multiple positions AND one must be 'DEF'
WHERE size(all_positions) > 1 AND 'DEF' IN all_positions

// 4. Unwind the fixture data to calculate scores for each match
UNWIND all_match_data AS data_row
WITH player_surname, all_names, data_row.played AS played, data_row.fixture AS f, data_row.gameweek AS gw, all_match_data

// 5. Calculate the Hypothetical Defender Score (def_score)
WITH player_surname, all_names, played, f, gw, all_match_data,
    played.total_points AS actual_points, // Expose total_points here
    // Calculate def_score using all applicable rules
    (CASE WHEN played.minutes >= 60 THEN 2 WHEN played.minutes > 0 THEN 1 ELSE 0 END) +
    (played.goals_scored * 6) + (played.assists * 3) + (played.yellow_cards * -1) +
    (played.red_cards * -3) + (played.penalties_missed * -2) + (played.own_goals * -2) +
    (CASE WHEN played.minutes > 60 AND played.goals_conceded = 0 THEN 4 ELSE 0 END) +
    (-1 * toInteger(floor(played.goals_conceded / 2))) AS def_score

// 6. Filter for Mismatches: actual total_points must NOT equal the calculated def_score
WHERE def_score <> actual_points

// 7. Aggregate the results back to the unified player (surname)
WITH player_surname, all_names, all_match_data, 
     count(f) AS not_def_fixtures,
     collect({
        def_score: def_score,
        season: gw.season,
        fixture_number: f.fixture,
        matches_def: def_score = actual_points,
        total_points: actual_points
    }) AS fixture_details

// 8. FINAL RETURN: Group results by the common surname
RETURN head(all_names) AS player, // Use the first name fragment found for the unified person
       not_def_fixtures, 
       size(all_match_data) AS total_fixtures, // Total fixtures for the unified person
       fixture_details AS fixture_details_list
ORDER BY player DESC